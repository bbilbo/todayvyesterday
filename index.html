<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" type="text/css" href="button.css">
<style type="text/css">
body
{
font-family:Arial, Helvetica, sans-serif;
color: rgb(113, 112, 112);
background-image:url("images/background.png");
}
#top_area {
  font-size:20px;
  background-color:#FFFFFF;
  border-bottom: 2px rgb(113, 112, 112) solid;
  width:100%;
  height: 120px;
  vertical-align: center;
  padding: 15px;
  padding-left: 120px;
}
#bottom_area {
  padding-top: 10px;
  padding-left: 120px;
  font-size:60px;
  margin:10px;
  padding-bottom: 20px;
}
#footer {
  padding-left: 120px;
  background-color:#ffffff;
  font-size: 19px;
}

#get_the_weather {
	float: left;
	display: inline;
}

#get_weather_text {
	float: left;
}

#compute {
		float: left;
		margin-top:25px;
}

#compute2 {
		
		
}
</style>







<!-- 
  blue: #c5dee8
  -->
</head>

<body style="margin:0px;">

<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script src="/node_modules/async/lib/async.js"></script>

<div id="top_area">
  <br><span style="font-size:41px">Weather - Today v Yesterday</span><br><span>See how today's weather compares to yesterday's.
</div>

<div id="bottom_area">
  <div id="init_message">
    <div id="get_the_weather"><span id="get_weather_text">Get the weather:&nbsp;</span><button onclick="getWeatherButton()" id="compute">Go</button></div>
  </div>

  <div id="status"></div>

  <div id="current_location_div" style="visibility:hidden">Location: <span style="text-decoration:underline; cursor:pointer" id="current_location_span" onclick="location_clicked()"></span><span id="new_location_span" style="visibility:hidden"><input type="text" id="zipcode_input" value="Enter Zip Code" onfocus="zipcode_focus()"/><input type="submit" id="compute2" value="Go" onclick="new_zipcode_go()"></span><span id="go2_error" style="font-size:10px; padding-left:10px; color:red"></span></div>

  <div id="current_temp"></div>

  <div id="yesterday_temp"></div>

  <div id="diff_temp"></div>
</div>

<div id="footer">
  <div id="help"></div>
</div>








<script>

var dev_env = false;

var dev_latitude = 40.7684912;
var dev_longitude = -73.9564793;

var info1 = document.getElementById("info1");

var current_location_div = document.getElementById("current_location_div");
var current_location_span = document.getElementById("current_location_span");
var new_location_span = document.getElementById("new_location_span");
var zipcode_input = document.getElementById("zipcode_input");
var compute2 = document.getElementById("compute2");

var go2_error = document.getElementById("go2_error");

var p_current_temp = document.getElementById("current_temp");
var p_yesterday_temp = document.getElementById("yesterday_temp");
var p_diff_temp = document.getElementById("diff_temp");
var div_status = document.getElementById("status");
var init_message = document.getElementById("init_message");
var div_help = document.getElementById("help");

var todays_temp;
var yesterdays_temp;

// helper functions

function isValidUSZip(sZip) {
   return /^\d{5}(-\d{4})?$/.test(sZip);
}

function new_zipcode_go() {
	console.log("function start: new_zipcode_go()");

	if (isValidUSZip(zipcode_input.value)) {
	  compute2.style.visibility = "hidden";
	
		go2_error.innerHTML = "";
		
		localStorage.users_zipcode = zipcode_input.value;
		
		localStorage.manual_override = true;
		todays_temp = null;
		yesterdays_temp = null;
		
		//current_location_div.style.visibility = "hidden";
		p_current_temp.innerHTML = "";
		p_yesterday_temp.innerHTML = "";
		p_diff_temp.innerHTML = "";
		div_help.innerHTML = "";
		
		zipcode_input.style.visibility = "hidden";
		current_location_div.style.visibility = "hidden";
		
		getWeatherButton();
	} else {
		go2_error.innerHTML = "Please enter a valid 5 digit zip code.";
	}
}

function zipcode_focus() {
	zipcode_input.value = "";
}

function location_clicked() {
  console.log("function start: location_clicked()");
	current_location_span.style.display = "none";
	new_location_span.style.visibility = "visible";
	
	zipcode_input.style.visibility = "visible";
	compute2.style.visibility = "visible";
}

function goGo() {
	var type = window.location.hash.substr(1);
	console.log("hash: " + type);
	if (type == "go") {
		getWeatherButton();
	}
}

function getLocationButton() {
  getLocation();
}

function getLocation() {
  console.log("function start: getLocation()");

	if (localStorage.manual_override) {
		
	} else if (dev_env) {
    localStorage.users_latitude = dev_latitude;
    localStorage.users_longitude = dev_longitude;
  } else {
    getCurPos();
  }

  console.log("function end: getLocation()");
}

function getCurPos() {
  console.log("function start: getCurPos()");
  if (navigator.geolocation) {
    
    navigator.geolocation.getCurrentPosition(getCurPosCallback);
    
  } else {
    p_current_temp.innerHTML="Geolocation is not supported by this browser.";
  }
  console.log("function end: getCurPos()");
}

function getCurPosCallback(position) {	
  console.log("function start: getCurPosCallback()");
  
  localStorage.users_latitude = position.coords.latitude;
  localStorage.users_longitude = position.coords.longitude;

  div_status.innerHTML="Got current location.";
  
  console.log("function end: getCurPosCallback()");
}

// functions that call weatherunderground

function getWeatherButton() {
  console.log("function start: getWeatherButton()");

  init_message.style.display = "none";
  div_status.innerHTML="Getting current location.";

  getLocation();

  var count = 0;

  async.whilst(
      function () {
        if (count == 15) {
          console.log("waited 15 seconds for location");
          return false;
				} else if (localStorage.manual_override) {
					return false;
        } else {
          var test1 = localStorage.users_latitude == null;
          var test2 = localStorage.users_longitude == null;
          return test1 || test2;
        }
      },
      function (callback) {
          count++;
          console.log("waiting for location (" + localStorage.users_latitude + ", " + localStorage.users_longitude + ")");
          setTimeout(callback, 1000);
      },
      function (err) {
          getWeatherButtonCallback();
      }
  );
}

function getWeatherButtonCallback() {
  console.log("function start: getWeatherButtonCallback()");

  div_status.innerHTML="Getting yesterday's weather.";

  async.series([
      getCurrentWeather(),
      getYesterdayWeather()
  ]);

  var count = 0;

  async.whilst(
      function () {
        if (count == 15) {
          console.log("waited 15 seconds for temperatures (" + todays_temp + ", " + yesterdays_temp + ")");
          return false;
        } else {
          var test1 = todays_temp == null;
          var test2 = yesterdays_temp == null;
          return test1 || test2;
        }
      },
      function (callback) {
          count++;
          console.log("waiting for temperatures (" + todays_temp + ", " + yesterdays_temp + ")");
          setTimeout(callback, 1000);
      },
      function (err) {
          getWeather();
      }
  );

  console.log("function end: getWeatherButton()");
}

function getWeather() {
  console.log("function start: getWeather()");
  
  var diff_description;
  var diff_amount;
  var help_text = "";

  console.log("todays_temp: " + todays_temp);
  console.log("yesterdays_temp: " + yesterdays_temp);

  if (todays_temp > yesterdays_temp) {
    diff_description = "warmer";
    diff_amount = todays_temp - yesterdays_temp;

    if (diff_amount > 4) {
      help_text = "looks like it is warmer today. maybe you could dress a bit lighter"
    }

  } else {
    diff_description = "cooler";
    diff_amount = yesterdays_temp - todays_temp;

    if (diff_amount > 4) {
      help_text = "looks like it is cooler today. maybe you should dress a bit heavier"
    }

  }

  diff_amount = Math.round(diff_amount * 100) / 100;

  var display_text = "It's " + diff_amount + "° " + diff_description + " than yesterday.";

  p_diff_temp.innerHTML = display_text;
  div_status.innerHTML="";

  div_help.innerHTML = help_text;

  console.log("function end: getWeather()");
}

function getCurrentWeatherButton() {
  console.log("function start: getCurrentWeatherButton()");

  async.series([
      getLocation(),
      getCurrentWeather()
  ]);

  console.log("function end: getCurrentWeatherButton()");
}

function getCurrentWeather() {
  console.log("function start: getCurrentWeather()");
  
	var query_str = localStorage.users_latitude + "," + localStorage.users_longitude;
	
	if (localStorage.manual_override) {
		query_str = String(localStorage.users_zipcode);
	}
	
  var wunderground_url = "http://api.wunderground.com/api/31d46c83b443d545/geolookup/conditions/q/" + query_str + ".json";
  
  console.log("asking wunderground question: " + wunderground_url);
  
  jQuery(document).ready(function($) {
    $.ajax({
      url : wunderground_url,
      dataType : "jsonp",
      success : function(parsed_json) {
        var location = parsed_json['location']['city'];
        todays_temp = parsed_json['current_observation']['temp_f'];

        div_status.innerHTML="";
        current_location_div.style.visibility = "visible";
				if (localStorage.manual_override) {
					current_location_span.innerHTML = "" + localStorage.users_zipcode;
				} else {
					current_location_span.innerHTML = "" + location;
				}
				current_location_span.style.display = "";
        p_current_temp.innerHTML = "Current temp: " + todays_temp + "°";
      }
    });
  });
  
  console.log("function end: getCurrentWeather()");
}

function getYesterdayWeatherButton() {
  console.log("function start: getYesterdayWeatherButton()");

  async.series([
      getLocation(),
      getYesterdayWeather()
  ]);

  console.log("function end: getYesterdayWeatherButton()");
}

//  http://api.wunderground.com/api/31d46c83b443d545/yesterday/q/85745.json

function getYesterdayWeather() {
  console.log("function: getYesterdayWeather()");
	
	var query_str = localStorage.users_latitude + "," + localStorage.users_longitude;
	
	if (localStorage.manual_override) {
		query_str = String(localStorage.users_zipcode);
	}
  
  var wunderground_url = "http://api.wunderground.com/api/31d46c83b443d545/yesterday/q/" + query_str + ".json";
  
  console.log("asking wunderground question: " + wunderground_url);
  
  jQuery(document).ready(function($) {
    $.ajax({
      url : wunderground_url,
      dataType : "jsonp",
      success : function(parsed_json) {
        var observations = parsed_json['history']['observations'];

        var observations_length = observations.length;

        var current_date = new Date();
        var current_hour = current_date.getHours();

        for(ii = 0; ii < observations_length; ii++) {

          var observation_hour = observations[ii]['date']['hour'];
          if (observation_hour == current_hour) {
            console.log("found hour");
            yesterdays_temp = observations[ii]['tempi'];
          }

        }

        p_yesterday_temp.innerHTML = "Yesterday's temp: " + yesterdays_temp + "°";
      }
    });
  });

}

window.onload = goGo();

</script>
</body>
</html>